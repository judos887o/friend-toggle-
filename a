local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Player = Players.LocalPlayer

task.spawn(function()
    if not game:IsLoaded() then game.Loaded:Wait() end

    local MyPlot = nil
    for _, plot in ipairs(Workspace.Plots:GetChildren()) do
        for _, obj in ipairs(plot:GetDescendants()) do
            if obj:IsA("TextLabel") and obj.Text and (obj.Text:find(Player.Name) or obj.Text:find(Player.DisplayName)) then
                MyPlot = plot
                break
            end
        end
        if MyPlot then break end
    end

    if not MyPlot then return end

    local FriendPanel = MyPlot:FindFirstChild("FriendPanel")
    if not FriendPanel then return end

    local function GetPrompt()
        local mainPart = FriendPanel:FindFirstChild("Main")
        if mainPart then
            return mainPart:FindFirstChildWhichIsA("ProximityPrompt")
        end
    end

    local LaserMain = MyPlot:FindFirstChild("LaserHitbox") and MyPlot.LaserHitbox:FindFirstChild("Main")
    if not LaserMain then return end

    local DetectionCenter = Instance.new("Part")
    DetectionCenter.Size = Vector3.new(1, 1, 1)
    DetectionCenter.Transparency = 1
    DetectionCenter.Anchored = true
    DetectionCenter.CanCollide = false
    DetectionCenter.CFrame = LaserMain.CFrame
    DetectionCenter.Parent = Workspace

    local gui3 = Instance.new("ScreenGui")
    gui3.Name = "LaserToggle"
    gui3.ResetOnSpawn = false
    gui3.Parent = Player:WaitForChild("PlayerGui")

    local mainBtn = Instance.new("TextButton")
    mainBtn.Size = UDim2.new(0, 280, 0, 90)
    mainBtn.Position = UDim2.new(1, -900, 1, -200)
    mainBtn.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
    mainBtn.Text = "FRIEND LASER TOGGLE"
    mainBtn.TextColor3 = Color3.new(1, 1, 1)
    mainBtn.Font = Enum.Font.GothamBlack
    mainBtn.TextSize = 26
    mainBtn.AutoButtonColor = false
    mainBtn.Parent = gui3
    Instance.new("UICorner", mainBtn).CornerRadius = UDim.new(0, 20)
    Instance.new("UIStroke", mainBtn).Thickness = 4

    local autoBlockBtn = Instance.new("TextButton")
    autoBlockBtn.Size = UDim2.new(0, 280, 0, 70)
    autoBlockBtn.Position = UDim2.new(1, -900, 1, -100)
    autoBlockBtn.BackgroundColor3 = Color3.fromRGB(80, 40, 100)
    autoBlockBtn.Text = "AUTO BLOCK: OFF"
    autoBlockBtn.TextColor3 = Color3.new(1, 1, 1)
    autoBlockBtn.Font = Enum.Font.GothamBold
    autoBlockBtn.TextSize = 22
    autoBlockBtn.AutoButtonColor = false
    autoBlockBtn.Parent = gui3
    Instance.new("UICorner", autoBlockBtn).CornerRadius = UDim.new(0, 16)
    Instance.new("UIStroke", autoBlockBtn).Thickness = 3

    local credit = Instance.new("TextLabel")
    credit.Size = UDim2.new(1, 0, 0, 30)
    credit.Position = UDim2.new(0, 0, 0, -35)
    credit.BackgroundTransparency = 1
    credit.Text = "By schmeckt (Keybind R)"
    credit.TextColor3 = Color3.new(0.8, 0.8, 0.8)
    credit.Font = Enum.Font.GothamBold
    credit.TextSize = 16
    credit.Parent = mainBtn

    local AutoBlockEnabled = false
    local HasTriggered = false

    local function Toggle()
        local prompt = GetPrompt()
        if prompt then
            fireproximityprompt(prompt)
        end
    end

    mainBtn.MouseButton1Click:Connect(Toggle)

    UserInputService.InputBegan:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.R then
            Toggle()
        end
    end)

    autoBlockBtn.MouseButton1Click:Connect(function()
        AutoBlockEnabled = not AutoBlockEnabled
        autoBlockBtn.Text = AutoBlockEnabled and "AUTO BLOCK: ON" or "AUTO BLOCK: OFF"
        autoBlockBtn.BackgroundColor3 = AutoBlockEnabled and Color3.fromRGB(138, 43, 226) or Color3.fromRGB(80, 40, 100)
        if not AutoBlockEnabled then
            HasTriggered = false
        end
    end)

    RunService.Heartbeat:Connect(function()
        if not AutoBlockEnabled or HasTriggered then return end
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = player.Character.HumanoidRootPart
                if (hrp.Position - DetectionCenter.Position).Magnitude < 30 then
                    Toggle()
                    HasTriggered = true
                    return
                end
            end
        end
    end)
end)
